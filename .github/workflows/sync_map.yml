name: Sync Directory Map and README

on:
  workflow_dispatch:
  push:
    paths:
      - "docs/**"
      - "articles/**"
      - "knowledge/**"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Rebuild directory_map.json
        run: |
          python3 - <<'PY'
          import os, json
          data = {}
          for r, _, fs in os.walk('.'):
              if any(x in r for x in ['.git', 'node_modules']): continue
              md = [f for f in fs if f.endswith(('.md','.json'))]
              if md: data[r] = md
          with open('knowledge/directory_map.json','w',encoding='utf-8') as f:
              json.dump({'auto_generated': True, 'structure': data}, f, indent=2, ensure_ascii=False)
          PY

      - name: Update README_NoteGen.md
        run: |
          python3 - <<'PY'
          import re
          text=open('README_NoteGen.md','r',encoding='utf-8').read()
          section_header="## ðŸ“š é‹ç”¨ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä¸€è¦§"
          if section_header in text:
              pre, _ = text.split(section_header, 1)
          else:
              pre = text
          table = """## ðŸ“š é‹ç”¨ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä¸€è¦§
| åç§° | æ¦‚è¦ | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ |
|------|------|---------------|
| ã‚·ãƒªãƒ¼ã‚ºç®¡ç†è¦ç´„ | é€£è¼‰è¨˜äº‹ã®å‘½åãƒ»æ§‹æˆãƒ«ãƒ¼ãƒ« | docs/series_management_protocol.md |
| ä¿å­˜è¦ç´„ | PowerShellä¿å­˜ã¨GitHubé€£æº (SHAâ†’Base64 commit ruleå¯¾å¿œ) | docs/save_protocol.md |
| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ§‹é€ ä¸€è¦§ | knowledge/directory_map.json |
"""
          new_text = pre + table
          open('README_NoteGen.md','w',encoding='utf-8').write(new_text)
          PY

      - name: Commit and push
        run: |
          git config --global user.name "PONTA Bot"
          git config --global user.email "ponta-bot@notegen.system"
          git add knowledge/directory_map.json README_NoteGen.md
          git commit -m "auto-sync: refresh directory_map and README" || echo "No changes"
          git push origin main

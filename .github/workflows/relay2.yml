name: Relay2

on: 
  workflow_dispatch:
    inputs:
      message:
        description: "Trigger message"
        required: false
        default: "Manual trigger by PONTA"

permissions:
  contents: write

hubs:
  collect-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@f4
        with:
          fetch-depth: 0

      - name: Setup PowerShell
        uses: actions/setup-pwsh@v4

      - name: Generate commits map using PONTA Functions
        shell: pwsh
        run: |
          Write-Host "ğŸ”¥ Loading Save_NoteGen_Functions.ps1 ..."
          if (Test-Path ./Save_NoteGen_Functions.ps1) {
            . .\Save_NoteGen_Functions.ps1
            Write-Host "ğŸ”¥ Running Save-CommitMap ..."
            Save-CommitMap -RepoPath . -OutFile commits_map.json -Count 10
          } else {
            Write-Error "ğŸ˜Œ Save_NoteGen_Functions.ps1 not found!"
            exit 1
          }

      - name: Display commits_map.json
        run: |
          echo "----- commits_map.json -------"
          cat commits_map.json || echo "ğŸ‡ No commits_map.json generated"
          echo "--------------------------------------------"

      - name: Upload commit map as artifact
        uses: actions/upload-artifact@v4
        with:
          name: commits_map
          path: ./commits_map.json

      - name: Sync commit map to Vercel
        run: |
          echo "âŸ”’ Syncing commits map to Vercel..."
          curl -X POST "https://notegen-gpts-api.vercel.app/api/createOrUpdateFile" \
          -H Content-Type: application/json \
          -d {"path": "commits_map.json", "content": "$(base64 commits_map.json)", "message": "Auto-sync commits map from Relay2"}
          echo "â¡ Synced to Vercel successfully."